<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ternary Breathing</title>
  <!-- Tailwind CDN (JIT) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- prettier font -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root { --blue: 59,130,246; }
    .gpu { will-change: transform, opacity; backface-visibility: hidden; transform: translateZ(0); }
    .ripple {
      position: absolute; inset: 0; border-radius: 9999px; pointer-events: none;
      border: 2px solid rgba(var(--blue), 0.35);
      box-shadow: 0 0 0 0 rgba(var(--blue), 0.0);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-200 antialiased font-[Manrope] flex items-center justify-center overflow-hidden">
  <main class="w-full max-w-xl px-6 py-10 text-center select-none">
    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">ternary breathing</h1>
    <p class="mt-2 opacity-80">breathe in, hold, release</p>

    <!-- stage wraps circle + ripples -->
    <div id="stage" class="relative mx-auto mt-10 mb-6 w-48 h-48 sm:w-64 sm:h-64 md:w-80 md:h-80 lg:w-96 lg:h-96">
      <div id="circle" class="gpu absolute inset-0 rounded-full bg-blue-500 shadow-xl"></div>
      <!-- ripples injected by JS -->
    </div>

    <!-- status -->
    <h2 id="status" class="text-xl sm:text-2xl font-semibold opacity-80">press start</h2>

    <!-- controls -->
    <div class="mt-8 flex flex-wrap items-center justify-center gap-3">
      <button id="startBtn" class="px-5 py-2.5 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-0 disabled:opacity-50 disabled:cursor-not-allowed">
        start
      </button>
      <button id="stopBtn" class="px-5 py-2.5 bg-gray-700 text-white rounded-full shadow hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 hidden">
        stop
      </button>
      <label class="ml-2 inline-flex items-center gap-2 text-sm opacity-80">
        speed
        <select id="speed" class="bg-gray-800 border border-gray-700 rounded-md px-2 py-1 text-sm">
          <option value="4000">slow</option>
          <option value="3000" selected>medium</option>
          <option value="2000">fast</option>
        </select>
      </label>
    </div>

    <!-- legend -->
    <div class="mt-6 text-xs opacity-70">
      <span class="align-middle">+1 inhale</span>
      <span class="mx-2">•</span>
      <span class="align-middle">0 hold</span>
      <span class="mx-2">•</span>
      <span class="align-middle">-1 exhale</span>
    </div>
  </main>

  <script>
    const stage = document.getElementById('stage');
    const circle = document.getElementById('circle');
    const statusText = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const speedSel = document.getElementById('speed');

    let running = false;
    let circleAnim, ripple1Anim, ripple2Anim, rafId;
    let ripple1, ripple2;

    function cleanup() {
      [circleAnim, ripple1Anim, ripple2Anim].forEach(a => a && a.cancel());
      if (rafId) cancelAnimationFrame(rafId);
      ripple1 && ripple1.remove();
      ripple2 && ripple2.remove();
      ripple1 = ripple2 = null;
      circle.style.transform = 'scale(0.8)';
      statusText.textContent = 'press start';
    }

    function mkRipple() {
      const el = document.createElement('div');
      el.className = 'ripple gpu';
      stage.appendChild(el);
      return el;
    }

    function start() {
      if (running) return; running = true;
      startBtn.disabled = true; stopBtn.classList.remove('hidden'); startBtn.textContent = 'running…';

      const phase = parseInt(speedSel.value, 10); // ms per phase
      const T = phase * 3; // full cycle

      // create ripples
      ripple1 = mkRipple();
      ripple2 = mkRipple();

      // main scale animation – continuous, no resets
      circleAnim = circle.animate([
        { offset: 0.00, transform: 'scale(0.80)' },      // small
        { offset: 0.333, transform: 'scale(1.22)' },     // inhale
        { offset: 0.666, transform: 'scale(1.22)' },     // hold plateau
        { offset: 1.00, transform: 'scale(0.80)' }       // exhale back
      ], { duration: T, iterations: Infinity, easing: 'cubic-bezier(.22,.61,.36,1)' });

      // ripples that only run during the hold window via keyframe gating
      const rippleKF = (startFrac, endFrac) => ([
        { offset: 0.00, transform: 'scale(1)', opacity: 0 },
        { offset: Math.max(0.001, startFrac - 0.01), transform: 'scale(1)', opacity: 0 },
        { offset: startFrac, transform: 'scale(1.0)', opacity: 0.35 },
        { offset: (startFrac + endFrac)/2, transform: 'scale(1.55)', opacity: 0.18 },
        { offset: endFrac, transform: 'scale(1.9)', opacity: 0.0 },
        { offset: 1.00, transform: 'scale(1.9)', opacity: 0 }
      ]);

      ripple1Anim = ripple1.animate(rippleKF(0.36, 0.54), { duration: T, iterations: Infinity, easing: 'linear' });
      ripple2Anim = ripple2.animate(rippleKF(0.46, 0.64), { duration: T, iterations: Infinity, easing: 'linear' });

      // status text synced without interrupting animations
      const step = () => {
        if (!running) return; // safety
        const t = circleAnim.currentTime % T;
        if (t < phase) {
          statusText.textContent = 'breathe in (+1)';
        } else if (t < phase * 2) {
          statusText.textContent = 'hold (0)';
        } else {
          statusText.textContent = 'breathe out (-1)';
        }
        rafId = requestAnimationFrame(step);
      };
      rafId = requestAnimationFrame(step);
    }

    function stop() {
      running = false;
      startBtn.disabled = false; startBtn.textContent = 'start'; stopBtn.classList.add('hidden');
      cleanup();
    }

    // init baseline scale small
    circle.style.transform = 'scale(0.8)';

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    speedSel.addEventListener('change', () => { if (running) { stop(); start(); } });
    window.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if (k === 's') start();
      if (k === 'x') stop();
    });
  </script>
</body>
</html>
